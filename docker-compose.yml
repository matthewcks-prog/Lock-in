# =============================================================================
# Lock-in Backend - Docker Compose for Local Development
# Use this to test the containerized backend with LOCAL Supabase
# =============================================================================
# PREREQUISITE: Start local Supabase first with: npx supabase start
#
# SETUP:
# 1. Ensure .env.local exists with correct Supabase JWT keys (run: npx supabase status -o env)
# 2. Run: npx supabase start (to start local Supabase)
# 3. Run: docker compose --env-file .env.local up (to start the backend)
#
# IMPORTANT: Use 'docker compose --env-file .env.local up' to load secrets properly
# =============================================================================

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
      # TARGET THE DEVELOPMENT STAGE (Includes nodemon and devDeps)
      target: development
    container_name: lock-in-backend
    # Load environment from .env.local - contains actual secrets
    # NOTE: Use 'docker compose --env-file .env.local up' for variable interpolation
    env_file:
      - .env.local
    ports:
      - '3000:3000'
    environment:
      # Environment selection (ALWAYS development for local Docker testing)
      - NODE_ENV=development
      - PORT=3000

      # Local Supabase Configuration
      # CRITICAL: Override SUPABASE_URL_DEV to use host.docker.internal
      # The value in .env.local points to 127.0.0.1, which doesn't work from inside container
      - SUPABASE_URL_DEV=http://host.docker.internal:54321

      # JWT Secret (legacy HS256 fallback - Supabase CLI v1.x+ uses ES256)
      # This is optional: ES256 tokens are verified via JWKS endpoint
      # Only needed if using older Supabase CLI versions with HS256 tokens
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET:-super-secret-jwt-token-with-at-least-32-characters-long}

      # Transcription temp directory
      - TRANSCRIPTION_TEMP_DIR=/tmp/transcripts

      # Rate limiting defaults (can be overridden in .env.local)
      - DAILY_REQUEST_LIMIT=100
      - TRANSCRIPT_DAILY_JOB_LIMIT=20
      - TRANSCRIPT_MAX_CONCURRENT_JOBS=3
    volumes:
      # Mount temp volume for transcription jobs
      - transcripts-temp:/tmp/transcripts
      # HOT RELOADING: Mount local backend folder to container's /app/backend
      - ./backend:/app/backend
      # PRESERVE NODE_MODULES: Shadow the host's node_modules with an anonymous volume
      # This enables the container to use its own compiled modules while syncing code
      - /app/backend/node_modules
    extra_hosts:
      # Allow container to reach host services (local Supabase)
      - 'host.docker.internal:host-gateway'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    # Resource limits (similar to Azure Container Apps)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

volumes:
  transcripts-temp:
    driver: local
