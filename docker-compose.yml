# =============================================================================
# Lock-in Backend - Docker Compose for Local Development
# Use this to test the containerized backend before Azure deployment
# =============================================================================

version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: lock-in-backend
    ports:
      - "3000:3000"
    environment:
      # Environment selection
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3000
      
      # Development Supabase (default)
      - SUPABASE_URL_DEV=${SUPABASE_URL_DEV}
      - SUPABASE_SERVICE_ROLE_KEY_DEV=${SUPABASE_SERVICE_ROLE_KEY_DEV}
      - SUPABASE_ANON_KEY_DEV=${SUPABASE_ANON_KEY_DEV:-}
      
      # Production Supabase (for testing prod config locally)
      - SUPABASE_URL_PROD=${SUPABASE_URL_PROD:-}
      - SUPABASE_SERVICE_ROLE_KEY_PROD=${SUPABASE_SERVICE_ROLE_KEY_PROD:-}
      - SUPABASE_ANON_KEY_PROD=${SUPABASE_ANON_KEY_PROD:-}
      
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Sentry (optional)
      - SENTRY_DSN=${SENTRY_DSN:-}
      
      # Transcription
      - TRANSCRIPTION_TEMP_DIR=/tmp/transcripts
      
      # Rate limiting (optional overrides)
      - DAILY_REQUEST_LIMIT=${DAILY_REQUEST_LIMIT:-100}
      - TRANSCRIPT_DAILY_JOB_LIMIT=${TRANSCRIPT_DAILY_JOB_LIMIT:-20}
      - TRANSCRIPT_MAX_CONCURRENT_JOBS=${TRANSCRIPT_MAX_CONCURRENT_JOBS:-3}
    volumes:
      # Mount temp volume for transcription jobs (optional, container has ephemeral storage)
      - transcripts-temp:/tmp/transcripts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    # Resource limits (similar to Azure Container Apps)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

volumes:
  transcripts-temp:
    driver: local

# =============================================================================
# Usage:
# 
# 1. Create .env file in project root with required variables:
#
#    # Development (default)
#    NODE_ENV=development
#    SUPABASE_URL_DEV=https://uszxfuzauetcchwcgufe.supabase.co
#    SUPABASE_SERVICE_ROLE_KEY_DEV=eyJ...
#    OPENAI_API_KEY=sk-...
#    SENTRY_DSN=https://...@sentry.io/...  (optional)
#
#    # Production (for testing prod config locally)
#    # NODE_ENV=production
#    # SUPABASE_URL_PROD=https://vtuflatvllpldohhimao.supabase.co
#    # SUPABASE_SERVICE_ROLE_KEY_PROD=eyJ...
#
# 2. Build and run (development by default):
#    docker-compose up --build
#
# 3. Run with production config:
#    NODE_ENV=production docker-compose up --build
#
# 4. Test health endpoint:
#    curl http://localhost:3000/health
#
# 5. Stop:
#    docker-compose down
#
# 6. View logs:
#    docker-compose logs -f backend
# =============================================================================
